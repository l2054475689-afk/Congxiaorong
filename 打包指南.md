# 凡人修仙3w天 - Android APK 打包指南

## 重要说明

本项目使用 **Flet** 框架开发，不是 Kivy。因此应该使用 Flet 的打包工具，而不是 buildozer。

## 一、环境准备

### 1. 安装必要的工具

```bash
# 安装 Flet
pip install flet

# 确保 Python 版本 >= 3.8
python --version
```

### 2. 安装 Android 打包依赖（仅 macOS/Linux）

如果在 macOS 或 Linux 上打包 Android APK：

```bash
# macOS 需要安装 Xcode Command Line Tools
xcode-select --install

# 安装 Java JDK (推荐 OpenJDK 11)
# macOS
brew install openjdk@11

# Ubuntu/Debian
sudo apt install openjdk-11-jdk

# 设置 JAVA_HOME 环境变量
export JAVA_HOME=/path/to/java
```

## 二、打包方法

### 方法一：使用 Flet Build（推荐）

Flet 提供了简单的打包命令：

```bash
# 进入项目目录
cd D:\desktop\mortal_3W_day\mortal_3W_day_1

# 打包 Android APK
flet build apk --project mortal_3W_day_1

# 或者使用移动端优化版
flet build apk --project mortal_3W_day_1 --module main_mobile
```

**打包参数说明：**
- `--project <name>`: 项目名称
- `--module <file>`: 指定主模块文件（不带.py后缀）
- `--build-number <number>`: 构建版本号
- `--build-version <version>`: 版本号

**完整打包命令示例：**

```bash
flet build apk \
  --module main_mobile \
  --build-number 1 \
  --build-version 1.0.0
```

### 方法二：使用 Flet Build Web（可选）

如果想先测试 Web 版本：

```bash
# 打包为 Web 应用
flet build web

# 本地测试
cd build/web
python -m http.server 8000
# 然后在浏览器访问 http://localhost:8000
```

## 三、常见问题及解决方案

### 1. 打包后 APP 闪退

**原因分析：**
- 数据库路径问题
- 缺少必要权限
- 依赖包版本不兼容
- 资源文件路径错误

**解决方案：**

#### A. 检查数据库路径
已在 `config.py` 中修复，确保使用应用内部存储：

```python
# config.py 已优化为自动检测平台
BASE_DIR = get_app_data_dir()  # 自动适配 Android/iOS/Windows/Linux
```

#### B. 检查权限配置
在 `flet.toml` 中已添加必要权限：

```toml
[android]
permissions = [
    "INTERNET",
    "WRITE_EXTERNAL_STORAGE",
    "READ_EXTERNAL_STORAGE"
]
```

#### C. 使用移动端优化版启动
使用 `main_mobile.py` 替代 `main.py`：

```bash
flet build apk --module main_mobile
```

### 2. 依赖包问题

**requirements.txt 优化：**

```txt
flet>=0.21.0
sqlalchemy>=2.0.0
pandas>=2.0.0
openpyxl>=3.1.0
requests>=2.30.0
Pillow>=10.0.0
```

**注意：** 移除不兼容的包：
- `reportlab` - 在 Android 上可能不兼容，如需 PDF 功能建议使用 Web API
- `schedule` - 在移动端建议使用 Flet 的定时器
- `psutil` - 在 Android 上不支持

### 3. 打包失败

**错误：`flet: command not found`**

解决：
```bash
pip install --upgrade flet
```

**错误：Java 环境问题**

解决：
```bash
# 确认 Java 已安装
java -version

# 设置 JAVA_HOME
export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
```

### 4. 在 Windows 上打包 Android APK

Windows 用户有两个选择：

**选项 A：使用 WSL2（推荐）**

```bash
# 在 WSL2 Ubuntu 中
sudo apt update
sudo apt install python3 python3-pip openjdk-11-jdk

# 安装 flet
pip3 install flet

# 打包
flet build apk
```

**选项 B：使用虚拟机或云服务**

使用 Linux 虚拟机或云服务（如 GitHub Actions）进行打包。

## 四、测试打包结果

### 1. 查找生成的 APK

打包成功后，APK 文件位于：

```
build/apk/app-release.apk
```

### 2. 安装到 Android 设备

```bash
# 使用 ADB 安装
adb install build/apk/app-release.apk

# 或者直接将 APK 文件传输到手机安装
```

### 3. 查看日志（如果闪退）

```bash
# 连接手机后查看日志
adb logcat | grep python

# 或者查看应用日志
adb logcat | grep fanrenxiuxian
```

## 五、优化建议

### 1. 减小 APK 体积

```bash
# 使用 release 模式打包
flet build apk --release

# 移除不必要的依赖
pip uninstall reportlab schedule psutil
```

### 2. 性能优化

- 使用 `main_mobile.py` 而不是 `main.py`
- 数据库操作使用连接池
- 图片资源压缩

### 3. 签名 APK（可选）

```bash
# 生成密钥库
keytool -genkey -v -keystore my-release-key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias my-key-alias

# 签名 APK
jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore my-release-key.jks build/apk/app-release.apk my-key-alias
```

## 六、替代方案：使用 GitHub Actions 自动打包

创建 `.github/workflows/build-apk.yml`：

```yaml
name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install flet

    - name: Build APK
      run: |
        flet build apk --module main_mobile

    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: app-release
        path: build/apk/app-release.apk
```

## 七、联系与支持

如遇到问题：
1. 检查 Flet 官方文档：https://flet.dev/docs/guides/python/packaging-app-for-distribution/
2. 查看项目 error.log 文件
3. 使用 `adb logcat` 查看详细错误信息

## 八、快速命令总结

```bash
# 完整的打包流程
cd D:\desktop\mortal_3W_day\mortal_3W_day_1

# 1. 确保环境正确
python --version  # 应该 >= 3.8
pip install --upgrade flet

# 2. 打包 APK
flet build apk --module main_mobile

# 3. 安装测试
adb install build/apk/app-release.apk

# 4. 查看日志（如果闪退）
adb logcat | grep python
```

---

**注意：** 本项目使用 Flet 框架，不要使用 buildozer 或 Kivy 相关的打包工具！
