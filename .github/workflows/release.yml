name: Create Release

# å½“æŽ¨é€æ ‡ç­¾æ—¶è§¦å‘
on:
  push:
    tags:
      - 'v*'  # ä¾‹å¦‚: v1.0.0, v2.1.3

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flet

    - name: Get version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"

    - name: Build APK
      run: |
        echo "Building Android APK for release ${{ steps.version.outputs.version }}..."
        flet build apk --module main_mobile

    - name: Prepare release artifacts
      run: |
        mkdir -p release
        APK_FILE=$(find build/apk -name "*.apk" -type f | head -n 1)
        if [ -n "$APK_FILE" ]; then
          cp "$APK_FILE" "release/mortal_3W_day-${{ steps.version.outputs.version }}.apk"
          echo "APK prepared: mortal_3W_day-${{ steps.version.outputs.version }}.apk"
          ls -lh release/
        else
          echo "Error: No APK file found!"
          exit 1
        fi

    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ðŸ“± å‡¡äººä¿®ä»™3wå¤© - ${{ steps.version.outputs.version }}

        ### âœ¨ æ–°ç‰ˆæœ¬å‘å¸ƒ

        è¿™æ˜¯ä¸€ä¸ªåŸºäºŽ Flet çš„ä¿®ä»™æ¨¡æ‹Ÿå™¨åº”ç”¨ã€‚

        ### ðŸ“¥ ä¸‹è½½
        - **Android APK**: `mortal_3W_day-${{ steps.version.outputs.version }}.apk`

        ### ðŸ”§ å®‰è£…è¯´æ˜Ž
        1. ä¸‹è½½ APK æ–‡ä»¶
        2. åœ¨ Android è®¾å¤‡ä¸Šå…è®¸å®‰è£…æœªçŸ¥æ¥æºçš„åº”ç”¨
        3. ç‚¹å‡» APK æ–‡ä»¶è¿›è¡Œå®‰è£…

        ### ðŸ“ æ›´æ–°å†…å®¹
        è¯·æŸ¥çœ‹æäº¤åŽ†å²äº†è§£è¯¦ç»†æ›´æ”¹ã€‚

        ---
        **æž„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **æž„å»ºæ¥æº**: GitHub Actions
        EOF
        cat release_notes.md

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.version.outputs.version }}
        body_path: release_notes.md
        files: |
          release/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts-${{ steps.version.outputs.version }}
        path: release/
        retention-days: 90
