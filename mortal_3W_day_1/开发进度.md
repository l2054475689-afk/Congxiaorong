# main.py #

import flet as ft
from ui.main_window import MainWindow

def main():
    """主函数"""
    # 创建主窗口实例
    window = MainWindow()
    
    # 启动应用
    ft.app(target=window.setup)

if __name__ == "__main__":
    main()


# config.py #import os
from pathlib import Path

# 应用基础配置
APP_NAME = "凡人修仙3w天"
VERSION = "1.0.0"
# 6.36英寸屏幕，按照16:9比例计算
WINDOW_WIDTH = 412  # 调整为更适合6.36英寸
WINDOW_HEIGHT = 915  # 调整高度

# 数据库配置
BASE_DIR = Path(__file__).parent
DB_PATH = BASE_DIR / "immortal_cultivation.db"

# 主题配置
class ThemeConfig:
    # 颜色配置
    PRIMARY_COLOR = "#667eea"  # 紫色主题
    PRIMARY_GRADIENT = ["#667eea", "#764ba2"]
    SUCCESS_COLOR = "#4CAF50"  # 绿色
    DANGER_COLOR = "#f5576c"   # 红色
    WARNING_COLOR = "#ffa500"  # 橙色
    GOLD_GRADIENT = ["#f6d365", "#fda085"]  # 金色渐变
    LIFE_GRADIENT = ["#f093fb", "#f5576c"]  # 生命渐变
    
    # 背景色
    BG_COLOR = "#f5f5f5"
    CARD_COLOR = "#ffffff"
    
    # 文字颜色
    TEXT_PRIMARY = "#333333"
    TEXT_SECONDARY = "#666666"
    TEXT_DISABLED = "#999999"
    
    # 尺寸配置
    PAGE_PADDING = 20
    CARD_PADDING = 15
    CARD_RADIUS = 10
    ITEM_SPACING = 10

# 游戏设定
class GameConfig:
    # 生命设定
    MAX_AGE = 80  # 最大年龄
    MINUTES_PER_DAY = 24 * 60  # 每天消耗的血量
    BLOOD_DECREASE_PER_MINUTE = 1  # 每分钟减少的血量
    
    # 心境设定
    MIN_SPIRIT = -80
    MAX_SPIRIT = 200
    DEFAULT_SPIRIT = 0
    
    # 灵石设定
    DEFAULT_TARGET_MONEY = 5000000  # 默认目标500万
    
    # 境界等级
    REALM_LEVELS = ["练气期", "筑基期", "结丹期", "元婴期", "化神期"]
	
# ui/main_window.py #
import flet as ft
import threading
import time
from database.db_manager import DatabaseManager
from database.models import Task
from systems.panel import PanelSystem
from systems.xinjing import XinjingSystem
from systems.jingjie import JingjieSystem
from systems.lingshi import LingshiSystem
from systems.tongyu import TongyuSystem
from systems.settings import SettingsSystem
from ui.task_widgets import TaskWidget
from config import APP_NAME, WINDOW_WIDTH, WINDOW_HEIGHT, ThemeConfig, GameConfig

class MainWindow:
    """主窗口类"""
    
    def __init__(self):
        self.db = DatabaseManager()
        self.current_page = "panel"
        self.blood_timer = None
        self.is_running = True
        
        # 初始化各个系统
        self.panel_system = PanelSystem(self.db)
        self.xinjing_system = XinjingSystem(self.db)
        self.jingjie_system = JingjieSystem(self.db)
        self.lingshi_system = LingshiSystem(self.db)
        self.tongyu_system = TongyuSystem(self.db)
        self.settings_system = SettingsSystem(self.db)
    
    def setup(self, page: ft.Page):
        """设置主窗口"""
        self.page = page
        self.page.title = APP_NAME
        self.page.theme_mode = ft.ThemeMode.LIGHT
        self.page.bgcolor = ThemeConfig.BG_COLOR
        
        # 设置窗口大小（适配6.36英寸屏幕）
        self.page.window_width = WINDOW_WIDTH
        self.page.window_height = WINDOW_HEIGHT
        self.page.window_resizable = False
        
        # 创建主容器
        self.main_content = ft.Column(expand=True)
        
        # 创建底部导航
        self.bottom_nav = self._create_bottom_nav()
        
        # 添加悬浮按钮（初始隐藏）
        self.fab = ft.FloatingActionButton(
            icon=ft.icons.ADD,
            bgcolor=ThemeConfig.PRIMARY_COLOR,
            on_click=self.show_add_dialog,
            visible=False,
        )
        
        # 添加到页面
        self.page.add(
            ft.Stack(
                controls=[
                    self.main_content,
                    ft.Container(
                        content=self.fab,
                        alignment=ft.alignment.bottom_right,
                        padding=20,
                    ),
                ],
                expand=True,
            )
        )
        self.page.bottom_appbar = self.bottom_nav
        
        # 启动血量自动减少定时器（每60秒减少1点血量）
        self.start_blood_timer()
        
        # 页面关闭时停止定时器
        self.page.on_disconnect = self.stop_blood_timer
        
        # 显示默认页面
        self.show_panel()
    
    def start_blood_timer(self):
        """启动血量自动减少定时器"""
        def decrease_blood():
            while self.is_running:
                time.sleep(60)  # 每60秒执行一次
                if self.is_running:
                    try:
                        # 减少1点血量
                        success = self.db.decrease_blood_by_time(1)
                        if success:
                            print("血量自动减少1点")
                            # 如果当前在面板页面，刷新显示
                            if self.current_page == "panel":
                                self.page.run_task(self.show_panel)
                    except Exception as e:
                        print(f"血量更新异常: {e}")
        
        self.blood_timer = threading.Thread(target=decrease_blood, daemon=True)
        self.blood_timer.start()
        print("血量定时器已启动")
    
    def stop_blood_timer(self, e=None):
        """停止血量定时器"""
        self.is_running = False
        print("血量定时器已停止")
    
    def _create_bottom_nav(self) -> ft.BottomAppBar:
        """创建底部导航栏"""
        nav_items = [
            ("面板", ft.icons.HOME, "panel", self.show_panel),
            ("心境", ft.icons.SELF_IMPROVEMENT, "xinjing", self.show_xinjing),
            ("境界", ft.icons.MENU_BOOK, "jingjie", self.show_jingjie),
            ("灵石", ft.icons.DIAMOND, "lingshi", self.show_lingshi),
            ("统御", ft.icons.PEOPLE, "tongyu", self.show_tongyu),
            ("设置", ft.icons.SETTINGS, "settings", self.show_settings),
        ]
        
        return ft.BottomAppBar(
            bgcolor=ThemeConfig.CARD_COLOR,
            content=ft.Row(
                controls=[
                    self._create_nav_item(label, icon, page_name, on_click)
                    for label, icon, page_name, on_click in nav_items
                ],
                alignment=ft.MainAxisAlignment.SPACE_AROUND,
            )
        )
    
    def _create_nav_item(self, label: str, icon, page_name: str, on_click):
        """创建导航项"""
        is_active = self.current_page == page_name
        return ft.Column(
            controls=[
                ft.IconButton(
                    icon=icon,
                    icon_color=ThemeConfig.PRIMARY_COLOR if is_active else ThemeConfig.TEXT_DISABLED,
                    icon_size=24,
                    tooltip=label,
                    on_click=lambda e: on_click(),
                ),
                ft.Text(
                    label, 
                    size=10,
                    color=ThemeConfig.PRIMARY_COLOR if is_active else ThemeConfig.TEXT_DISABLED,
                ),
            ],
            horizontal_alignment=ft.CrossAxisAlignment.CENTER,
            spacing=0,
        )
    
    def _update_nav_bar(self):
        """更新导航栏状态"""
        self.bottom_nav = self._create_bottom_nav()
        self.page.bottom_appbar = self.bottom_nav
        self.page.update()
    
    def _update_fab_visibility(self, visible: bool):
        """更新悬浮按钮可见性"""
        self.fab.visible = visible
        self.page.update()
    
    def show_panel(self):
        """显示个人面板"""
        self.current_page = "panel"
        self.main_content.controls = [self.panel_system.create_panel_view()]
        self._update_fab_visibility(False)
        self._update_nav_bar()
        self.page.update()
    
    def show_xinjing(self):
        """显示心境系统"""
        self.current_page = "xinjing"
        self.main_content.controls = [
            self.xinjing_system.create_xinjing_view(self.toggle_task)
        ]
        self._update_fab_visibility(True)
        self._update_nav_bar()
        self.page.update()
    
    def show_jingjie(self):
        """显示境界系统"""
        self.current_page = "jingjie"
        # 重新创建境界系统实例以刷新数据
        self.jingjie_system = JingjieSystem(self.db)
        self.main_content.controls = [self.jingjie_system.create_jingjie_view()]
        self._update_fab_visibility(False)
        self._update_nav_bar()
        self.page.update()
    
    def show_lingshi(self):
        """显示灵石系统"""
        self.current_page = "lingshi"
        # 重新创建灵石系统实例以刷新数据
        self.lingshi_system = LingshiSystem(self.db)
        self.main_content.controls = [self.lingshi_system.create_lingshi_view()]
        self._update_fab_visibility(False)
        self._update_nav_bar()
        self.page.update()
    
    def show_tongyu(self):
        """显示统御系统"""
        self.current_page = "tongyu"
        self.main_content.controls = [self.tongyu_system.create_tongyu_view()]
        self._update_fab_visibility(False)
        self._update_nav_bar()
        self.page.update()
    
    def show_settings(self):
        """显示设置"""
        self.current_page = "settings"
        self.main_content.controls = [self.settings_system.create_settings_view()]
        self._update_fab_visibility(False)
        self._update_nav_bar()
        self.page.update()
    
    def toggle_task(self, task: Task, completed: bool):
        """切换任务完成状态"""
        try:
            if completed:
                self.db.complete_task(task.id, task.spirit_effect, task.blood_effect)
                print(f"完成任务: {task.name} (心境{task.spirit_effect:+d}, 血量{task.blood_effect:+d})")
            else:
                self.db.uncomplete_task(task.id, task.spirit_effect, task.blood_effect)
                print(f"取消任务: {task.name}")
            
            # 刷新当前页面
            if self.current_page == "xinjing":
                self.show_xinjing()
            elif self.current_page == "panel":
                self.show_panel()
        except Exception as e:
            print(f"切换任务状态错误: {e}")
            # 显示错误提示
            self.show_error_dialog(f"操作失败: {str(e)}")
    
    def show_add_dialog(self, e):
        """显示添加对话框（根据当前页面）"""
        if self.current_page == "xinjing":
            self.show_add_task_dialog(e)
        # 其他页面可以添加相应的添加功能
    
    def show_add_task_dialog(self, e):
        """显示添加任务对话框"""
        def on_save(name: str, category: str, spirit_effect: int, blood_effect: int):
            try:
                self.db.add_task(name, category, spirit_effect, blood_effect)
                print(f"添加任务成功: {name}")
                self.show_xinjing()
            except Exception as ex:
                print(f"添加任务失败: {ex}")
                self.show_error_dialog(f"添加失败: {str(ex)}")
        
        dialog = TaskWidget.create_add_task_dialog(self.page, on_save)
        self.page.dialog = dialog
        dialog.open = True
        self.page.update()
    
    def show_error_dialog(self, message: str):
        """显示错误对话框"""
        def close_dialog(e):
            error_dialog.open = False
            self.page.update()
        
        error_dialog = ft.AlertDialog(
            title=ft.Text("错误", color=ThemeConfig.DANGER_COLOR),
            content=ft.Text(message),
            actions=[
                ft.TextButton("确定", on_click=close_dialog),
            ],
        )
        
        self.page.dialog = error_dialog
        error_dialog.open = True
        self.page.update()
    
    def refresh_current_page(self):
        """刷新当前页面"""
        page_methods = {
            "panel": self.show_panel,
            "xinjing": self.show_xinjing,
            "jingjie": self.show_jingjie,
            "lingshi": self.show_lingshi,
            "tongyu": self.show_tongyu,
            "settings": self.show_settings,
        }
        
        method = page_methods.get(self.current_page)
        if method:
            method()
		

# ui/styles.py #
import flet as ft
from config import ThemeConfig

class Styles:
    """UI样式定义"""
    
    @staticmethod
    def get_gradient(colors: list):
        """获取渐变色"""
        return ft.LinearGradient(
            begin=ft.alignment.top_left,
            end=ft.alignment.bottom_right,
            colors=colors,
        )
    
    @staticmethod
    def get_card_shadow():
        """获取卡片阴影"""
        return ft.BoxShadow(
            spread_radius=1,
            blur_radius=5,
            color="#1A000000",  # 10% 黑色透明度
        )
    
    @staticmethod
    def get_spirit_level_info(spirit_value: int) -> tuple:
        """根据心境值获取等级信息"""
        if spirit_value <= -80:
            return ("心魔入体", "#8b0000")
        elif -80 < spirit_value <= -60:
            return ("烦躁不堪", "#dc143c")
        elif -60 < spirit_value <= -20:
            return ("心烦意乱", "#ff6347")
        elif -20 < spirit_value <= 0:
            return ("略有烦躁", "#ffa500")
        elif 0 < spirit_value <= 40:
            return ("心平气和", "#90ee90")
        elif 40 < spirit_value <= 80:
            return ("清心寡欲", "#32cd32")
        elif 80 < spirit_value <= 100:
            return ("守静笃行", "#228b22")
        elif 100 < spirit_value <= 120:
            return ("虚怀若谷", "#4169e1")
        elif 120 < spirit_value <= 140:
            return ("返璞归真", "#9370db")
        else:
            return ("逍遥自在", "#8b008b")
			
			
			
# ui/task_widgets.py#
import flet as ft
from typing import Callable
from database.models import Task
from config import ThemeConfig

class TaskWidget:
    """任务组件"""
    
    @staticmethod
    def create_task_item(task: Task, on_toggle: Callable, show_details: bool = True):
        """创建任务项组件"""
        # 效果文字
        effects = []
        if task.spirit_effect != 0:
            sign = "+" if task.spirit_effect > 0 else ""
            effects.append(f"心境{sign}{task.spirit_effect}")
        if task.blood_effect != 0:
            sign = "+" if task.blood_effect > 0 else ""
            effects.append(f"血量{sign}{task.blood_effect}")
        effect_text = " ".join(effects)
        
        # 颜色设置
        checkbox_color = ThemeConfig.SUCCESS_COLOR if task.category == "positive" else ThemeConfig.DANGER_COLOR
        
        if show_details:
            return ft.Container(
                content=ft.Row(
                    controls=[
                        ft.Checkbox(
                            value=task.completed_today,
                            fill_color=checkbox_color,
                            on_change=lambda e, t=task: on_toggle(t, e.control.value),
                        ),
                        ft.Column(
                            controls=[
                                # 修复：直接使用字符串 "w500" 或使用 NORMAL/BOLD
                                ft.Text(task.name, size=14, weight="w500"),  # 使用字符串形式
                                # 或者使用：
                                # ft.Text(task.name, size=14, weight=ft.FontWeight.BOLD),  # 使用 BOLD
                                # ft.Text(task.name, size=14),  # 不指定weight，使用默认
                                ft.Text(f"({effect_text})", size=12, color=ThemeConfig.TEXT_SECONDARY),
                            ],
                            spacing=2,
                        ),
                    ],
                ),
                bgcolor=ThemeConfig.CARD_COLOR,
                padding=10,
                border_radius=8,
            )
        else:
            # 简化版任务项（用于面板）
            return ft.Row(
                controls=[
                    ft.Text("✓ " if task.completed_today else "○ ", color=checkbox_color),
                    ft.Text(task.name, size=14),
                    ft.Text(f"({effect_text})", size=12, color=ThemeConfig.TEXT_DISABLED),
                ],
            )
    
    @staticmethod
    def create_add_task_dialog(page: ft.Page, on_save: Callable):
        """创建添加任务对话框"""
        name_field = ft.TextField(label="任务名称", width=300)
        category_dropdown = ft.Dropdown(
            label="任务类型",
            width=300,
            options=[
                ft.dropdown.Option("positive", "正面修炼"),
                ft.dropdown.Option("negative", "心魔记录"),
            ],
            value="positive",
        )
        spirit_field = ft.TextField(
            label="心境影响", 
            width=140,
            value="0",
            keyboard_type=ft.KeyboardType.NUMBER,
        )
        blood_field = ft.TextField(
            label="血量影响", 
            width=140,
            value="0",
            keyboard_type=ft.KeyboardType.NUMBER,
        )
        
        def close_dialog(e):
            dialog.open = False
            page.update()
        
        def save_task(e):
            if name_field.value:
                on_save(
                    name=name_field.value,
                    category=category_dropdown.value,
                    spirit_effect=int(spirit_field.value or 0),
                    blood_effect=int(blood_field.value or 0),
                )
                close_dialog(e)
        
        dialog = ft.AlertDialog(
            title=ft.Text("添加新任务"),
            content=ft.Column(
                controls=[
                    name_field,
                    category_dropdown,
                    ft.Row([spirit_field, blood_field]),
                ],
                height=200,
            ),
            actions=[
                ft.TextButton("取消", on_click=close_dialog),
                ft.TextButton("保存", on_click=save_task),
            ],
        )
        
        return dialog


# systems/jingjie #
import flet as ft
from database.db_manager import DatabaseManager
from config import GameConfig, ThemeConfig
from typing import List, Dict

class JingjieSystem:
    """境界系统 - 技能成长管理"""
    
    def __init__(self, db_manager: DatabaseManager):
        self.db = db_manager
        self.current_realm = "练气期"
        self.selected_skill = None
        
        # 初始技能树结构
        self.skill_trees = {
            "心法": {
                "高等数学": {
                    "nodes": ["函数定义", "极限", "函数的极限", "微积分", "级数", "多元函数"],
                    "completed": [],
                    "realm": "练气期"
                },
                "Python编程": {
                    "nodes": ["基础语法", "numpy", "pandas", "matplotlib", "机器学习", "深度学习"],
                    "completed": [],
                    "realm": "练气期"
                },
                "英语": {
                    "nodes": ["单词", "语法", "听力", "口语", "阅读", "写作"],
                    "completed": [],
                    "realm": "练气期"
                }
            },
            "功法": {
                "跑步": {
                    "nodes": ["5公里", "10公里", "半马", "全马"],
                    "completed": [],
                    "realm": "练气期"
                },
                "八部金刚功": {
                    "nodes": ["第一式", "第二式", "第三式", "第四式", "第五式", "第六式", "第七式", "第八式"],
                    "completed": [],
                    "realm": "练气期"
                }
            },
            "秘术": {
                "紫微斗数": {
                    "nodes": ["八卦", "12星宿", "命盘", "流年", "大限", "小限"],
                    "completed": [],
                    "realm": "练气期"
                },
                "量化交易": {
                    "nodes": ["指标", "策略", "回测", "实盘", "风控", "优化"],
                    "completed": [],
                    "realm": "练气期"
                },
                "Web开发": {
                    "nodes": ["HTML", "CSS", "JavaScript", "React", "Node.js", "数据库"],
                    "completed": [],
                    "realm": "练气期"
                },
                "智能合约": {
                    "nodes": ["Solidity", "部署", "测试", "审计", "优化", "DeFi"],
                    "completed": [],
                    "realm": "练气期"
                }
            }
        }
        
        # 加载已保存的进度
        self._load_progress()
    
    def _load_progress(self):
        """从数据库加载技能进度"""
        # 这里应该从数据库加载，暂时使用模拟数据
        # 模拟一些已完成的进度
        self.skill_trees["心法"]["高等数学"]["completed"] = ["函数定义", "极限"]
        self.skill_trees["心法"]["Python编程"]["completed"] = ["基础语法", "numpy", "pandas", "matplotlib"]
        self.skill_trees["秘术"]["Web开发"]["completed"] = ["HTML", "CSS", "JavaScript"]
    
    def _save_progress(self, category: str, skill: str):
        """保存技能进度到数据库"""
        # TODO: 实现数据库保存逻辑
        pass
    
    def _calculate_progress(self, skill_data: dict) -> float:
        """计算技能完成进度"""
        if not skill_data["nodes"]:
            return 0.0
        return len(skill_data["completed"]) / len(skill_data["nodes"])
    
    def _get_realm_color(self, realm: str) -> str:
        """获取境界对应颜色"""
        realm_colors = {
            "练气期": "#9370DB",
            "筑基期": "#4169E1", 
            "结丹期": "#32CD32",
            "元婴期": "#FFD700",
            "化神期": "#FF6347"
        }
        return realm_colors.get(realm, "#999999")
    
    def _toggle_node(self, category: str, skill: str, node: str):
        """切换节点完成状态"""
        skill_data = self.skill_trees[category][skill]
        if node in skill_data["completed"]:
            skill_data["completed"].remove(node)
        else:
            skill_data["completed"].append(node)
        
        # 检查是否可以升级境界
        progress = self._calculate_progress(skill_data)
        if progress == 1.0 and skill_data["realm"] != "化神期":
            current_index = GameConfig.REALM_LEVELS.index(skill_data["realm"])
            if current_index < len(GameConfig.REALM_LEVELS) - 1:
                skill_data["realm"] = GameConfig.REALM_LEVELS[current_index + 1]
        
        # 保存进度
        self._save_progress(category, skill)
    
    def create_jingjie_view(self) -> ft.Column:
        """创建境界视图"""
        # 计算总体境界（取最高境界）
        all_realms = []
        for category in self.skill_trees.values():
            for skill_data in category.values():
                all_realms.append(skill_data["realm"])
        
        # 找出最高境界
        max_realm_index = 0
        for realm in all_realms:
            realm_index = GameConfig.REALM_LEVELS.index(realm)
            if realm_index > max_realm_index:
                max_realm_index = realm_index
        current_realm = GameConfig.REALM_LEVELS[max_realm_index]
        
        return ft.Column(
            controls=[
                # 标题栏
                ft.Container(
                    content=ft.Row(
                        controls=[
                            ft.Text("境界系统", size=20, weight=ft.FontWeight.BOLD),
                            ft.Container(
                                content=ft.Text(
                                    current_realm,
                                    size=14,
                                    color="white"
                                ),
                                bgcolor=self._get_realm_color(current_realm),
                                padding=ft.padding.symmetric(horizontal=10, vertical=5),
                                border_radius=20,
                            ),
                        ],
                        alignment=ft.MainAxisAlignment.SPACE_BETWEEN,
                    ),
                    padding=20,
                ),
                
                # 分类标签页
                ft.Container(
                    content=ft.Tabs(
                        selected_index=0,
                        animation_duration=300,
                        tabs=[
                            ft.Tab(
                                text="心法",
                                icon=ft.icons.AUTO_STORIES,
                                content=self._create_skill_list("心法"),
                            ),
                            ft.Tab(
                                text="功法", 
                                icon=ft.icons.FITNESS_CENTER,
                                content=self._create_skill_list("功法"),
                            ),
                            ft.Tab(
                                text="秘术",
                                icon=ft.icons.STAR,
                                content=self._create_skill_list("秘术"),
                            ),
                        ],
                    ),
                    padding=ft.padding.symmetric(horizontal=20),
                    expand=True,
                ),
            ],
            expand=True,
        )
    
    def _create_skill_list(self, category: str) -> ft.Column:
        """创建技能列表"""
        skills = self.skill_trees.get(category, {})
        
        skill_cards = []
        for skill_name, skill_data in skills.items():
            progress = self._calculate_progress(skill_data)
            skill_cards.append(self._create_skill_card(
                category, skill_name, skill_data, progress
            ))
        
        return ft.Column(
            controls=skill_cards,
            scroll=ft.ScrollMode.AUTO,
            spacing=15,
        )
    
    def _create_skill_card(self, category: str, name: str, data: dict, progress: float) -> ft.Container:
        """创建技能卡片"""
        def toggle_expansion(e):
            """切换展开/折叠状态"""
            card = e.control.parent.parent
            nodes_container = card.content.controls[2]
            nodes_container.visible = not nodes_container.visible
            card.update()
        
        # 创建节点列表
        nodes_list = []
        for i, node in enumerate(data["nodes"]):
            is_completed = node in data["completed"]
            
            def make_toggle_handler(n):
                return lambda e: self._handle_node_toggle(e, category, name, n)
            
            nodes_list.append(
                ft.Container(
                    content=ft.Row(
                        controls=[
                            ft.Checkbox(
                                value=is_completed,
                                fill_color=ThemeConfig.SUCCESS_COLOR if is_completed else None,
                                on_change=make_toggle_handler(node),
                            ),
                            ft.Text(
                                node,
                                size=14,
                                color=ThemeConfig.TEXT_PRIMARY if is_completed else ThemeConfig.TEXT_SECONDARY,
                            ),
                        ],
                    ),
                    padding=ft.padding.only(left=20),
                )
            )
        
        return ft.Container(
            content=ft.Column(
                controls=[
                    # 技能标题栏
                    ft.Container(
                        content=ft.Row(
                            controls=[
                                ft.Column(
                                    controls=[
                                        ft.Row(
                                            controls=[
                                                ft.Text(f"【{name}】", size=16, weight=ft.FontWeight.BOLD),
                                                ft.Container(
                                                    content=ft.Text(
                                                        data["realm"],
                                                        size=11,
                                                        color="white"
                                                    ),
                                                    bgcolor=self._get_realm_color(data["realm"]),
                                                    padding=ft.padding.symmetric(horizontal=8, vertical=2),
                                                    border_radius=10,
                                                ),
                                            ],
                                        ),
                                        ft.Text(f"{int(progress * 100)}% 完成", size=12, color=ThemeConfig.TEXT_SECONDARY),
                                    ],
                                    spacing=5,
                                ),
                                ft.IconButton(
                                    icon=ft.icons.EXPAND_MORE,
                                    icon_size=20,
                                    on_click=toggle_expansion,
                                ),
                            ],
                            alignment=ft.MainAxisAlignment.SPACE_BETWEEN,
                        ),
                        on_click=toggle_expansion,
                    ),
                    
                    # 进度条
                    ft.ProgressBar(
                        value=progress,
                        color=ThemeConfig.PRIMARY_COLOR,
                        bgcolor="#E0E0E0",
                        height=8,
                    ),
                    
                    # 节点列表（初始隐藏）
                    ft.Container(
                        content=ft.Column(
                            controls=nodes_list,
                            spacing=5,
                        ),
                        visible=False,
                    ),
                ],
                spacing=10,
            ),
            bgcolor=ThemeConfig.CARD_COLOR,
            padding=15,
            border_radius=10,
            shadow=ft.BoxShadow(
                spread_radius=1,
                blur_radius=5,
                color="#1A000000",
            ),
        )
    
    def _handle_node_toggle(self, e, category: str, skill: str, node: str):
        """处理节点切换事件"""
        self._toggle_node(category, skill, node)
        # 刷新页面
        page = e.page if hasattr(e, 'page') else e.control.page
        if page:
            # 找到主窗口并刷新境界页面
            for control in page.controls:
                if hasattr(control, 'controls') and len(control.controls) > 0:
                    main_content = control.controls[0]
                    if hasattr(main_content, 'controls'):
                        main_content.controls = [self.create_jingjie_view()]
                        page.update()
                        break




# systems/lingshi#
import flet as ft
from database.db_manager import DatabaseManager
from ui.styles import Styles
from config import ThemeConfig
from datetime import datetime, timedelta
from typing import List, Tuple

class LingshiSystem:
    """灵石系统 - 财务管理"""
    
    def __init__(self, db_manager: DatabaseManager):
        self.db = db_manager
        
        # 固定收支项目（示例数据，应从数据库加载）
        self.fixed_income = {
            "工资": 15000,
            "副业": 2000,
        }
        
        self.fixed_expense = {
            "房租": 3000,
            "房贷": 5000,
            "生活费": 2000,
        }
    
    def create_lingshi_view(self) -> ft.Column:
        """创建灵石视图"""
        user_data = self.db.get_user_data()
        current_money = user_data.current_money if user_data else 0
        target_money = user_data.target_money if user_data else 5000000
        progress = (current_money / target_money) * 100 if target_money > 0 else 0
        
        # 获取本月收支统计
        monthly_stats = self._get_monthly_stats()
        
        # 获取最近交易记录
        recent_records = self.db.get_finance_records(limit=10)
        
        return ft.Column(
            controls=[
                # 标题栏
                ft.Container(
                    content=ft.Row(
                        controls=[
                            ft.Text("灵石系统", size=20, weight=ft.FontWeight.BOLD),
                            ft.ElevatedButton(
                                "记账",
                                icon=ft.icons.ADD,
                                bgcolor=ThemeConfig.PRIMARY_COLOR,
                                color="white",
                                on_click=self._show_add_record_dialog,
                            ),
                        ],
                        alignment=ft.MainAxisAlignment.SPACE_BETWEEN,
                    ),
                    padding=20,
                ),
                
                # 当前灵石卡片
                ft.Container(
                    content=ft.Column(
                        controls=[
                            ft.Text("当前灵石", size=14, color="white"),
                            ft.Text(
                                f"¥{current_money:,.0f}",
                                size=32,
                                weight=ft.FontWeight.BOLD,
                                color="white"
                            ),
                            ft.Container(
                                content=ft.Column(
                                    controls=[
                                        ft.Text(f"目标: {target_money/10000:.0f}万", size=12, color="white"),
                                        ft.ProgressBar(
                                            value=min(progress/100, 1.0),
                                            color="white",
                                            bgcolor="#FFFFFF30",
                                            height=6,
                                        ),
                                        ft.Text(f"进度: {progress:.1f}%", size=12, color="white"),
                                    ],
                                    spacing=5,
                                ),
                            ),
                        ],
                        alignment=ft.MainAxisAlignment.CENTER,
                        horizontal_alignment=ft.CrossAxisAlignment.CENTER,
                        spacing=10,
                    ),
                    padding=30,
                    border_radius=20,
                    gradient=Styles.get_gradient(["#f6d365", "#fda085"]),
                    margin=ft.margin.symmetric(horizontal=20),
                ),
                
                # 本月统计卡片组
                ft.Container(
                    content=ft.Row(
                        controls=[
                            self._create_stat_card("本月收入", f"+{monthly_stats['income']:,.0f}", ThemeConfig.SUCCESS_COLOR),
                            self._create_stat_card("本月支出", f"-{monthly_stats['expense']:,.0f}", ThemeConfig.DANGER_COLOR),
                        ],
                        alignment=ft.MainAxisAlignment.SPACE_AROUND,
                    ),
                    margin=ft.margin.symmetric(horizontal=20, vertical=10),
                ),
                
                ft.Container(
                    content=ft.Row(
                        controls=[
                            self._create_stat_card("被动收入", f"+{monthly_stats['passive']:,.0f}", "#9370DB"),
                            self._create_stat_card("本月结余", 
                                                  f"{monthly_stats['income'] - monthly_stats['expense']:+,.0f}", 
                                                  "#4169E1"),
                        ],
                        alignment=ft.MainAxisAlignment.SPACE_AROUND,
                    ),
                    margin=ft.margin.symmetric(horizontal=20),
                ),
                
                # 固定收支配置
                ft.Container(
                    content=ft.ExpansionTile(
                        title=ft.Text("固定收支配置", size=16, weight=ft.FontWeight.BOLD),
                        subtitle=ft.Text("每月自动记录", size=12, color=ThemeConfig.TEXT_SECONDARY),
                        initially_expanded=False,
                        controls=[
                            self._create_fixed_items_list(),
                        ],
                    ),
                    margin=ft.margin.symmetric(horizontal=20, vertical=10),
                    bgcolor=ThemeConfig.CARD_COLOR,
                    border_radius=10,
                    padding=10,
                ),
                
                # 最近交易记录
                ft.Container(
                    content=ft.Column(
                        controls=[
                            ft.Text("【最近交易】", size=16, weight=ft.FontWeight.BOLD),
                            ft.Divider(height=1, color="#E0E0E0"),
                            *self._create_record_list(recent_records),
                        ],
                        spacing=10,
                    ),
                    padding=20,
                ),
            ],
            scroll=ft.ScrollMode.AUTO,
            expand=True,
        )
    
    def _get_monthly_stats(self) -> dict:
        """获取本月统计数据"""
        # TODO: 从数据库获取真实数据
        # 这里先返回示例数据
        return {
            "income": sum(self.fixed_income.values()) + 5000,  # 固定收入 + 其他收入
            "expense": sum(self.fixed_expense.values()) + 3000,  # 固定支出 + 其他支出
            "passive": 2000,  # 被动收入
        }
    
    def _create_stat_card(self, title: str, value: str, color: str) -> ft.Container:
        """创建统计卡片"""
        return ft.Container(
            content=ft.Column(
                controls=[
                    ft.Text(title, size=12, color=ThemeConfig.TEXT_SECONDARY),
                    ft.Text(
                        value,
                        size=18,
                        weight=ft.FontWeight.BOLD,
                        color=color
                    ),
                ],
                alignment=ft.MainAxisAlignment.CENTER,
                horizontal_alignment=ft.CrossAxisAlignment.CENTER,
            ),
            bgcolor=ThemeConfig.CARD_COLOR,
            padding=15,
            border_radius=10,
            width=160,
            shadow=Styles.get_card_shadow(),
        )
    
    def _create_fixed_items_list(self) -> ft.Column:
        """创建固定收支项目列表"""
        items = []
        
        # 固定收入项
        items.append(ft.Text("固定收入", size=14, weight=ft.FontWeight.BOLD, color=ThemeConfig.SUCCESS_COLOR))
        for name, amount in self.fixed_income.items():
            items.append(
                ft.Row(
                    controls=[
                        ft.Text(name, size=14),
                        ft.Text(f"+¥{amount:,.0f}", size=14, color=ThemeConfig.SUCCESS_COLOR),
                        ft.IconButton(
                            icon=ft.icons.EDIT,
                            icon_size=16,
                            on_click=lambda e, n=name, a=amount: self._edit_fixed_item(e, "income", n, a),
                        ),
                    ],
                    alignment=ft.MainAxisAlignment.SPACE_BETWEEN,
                )
            )
        
        items.append(ft.Divider(height=20))
        
        # 固定支出项
        items.append(ft.Text("固定支出", size=14, weight=ft.FontWeight.BOLD, color=ThemeConfig.DANGER_COLOR))
        for name, amount in self.fixed_expense.items():
            items.append(
                ft.Row(
                    controls=[
                        ft.Text(name, size=14),
                        ft.Text(f"-¥{amount:,.0f}", size=14, color=ThemeConfig.DANGER_COLOR),
                        ft.IconButton(
                            icon=ft.icons.EDIT,
                            icon_size=16,
                            on_click=lambda e, n=name, a=amount: self._edit_fixed_item(e, "expense", n, a),
                        ),
                    ],
                    alignment=ft.MainAxisAlignment.SPACE_BETWEEN,
                )
            )
        
        # 添加按钮
        items.append(
            ft.Row(
                controls=[
                    ft.TextButton(
                        "添加固定收入",
                        icon=ft.icons.ADD,
                        on_click=lambda e: self._add_fixed_item(e, "income"),
                    ),
                    ft.TextButton(
                        "添加固定支出",
                        icon=ft.icons.ADD,
                        on_click=lambda e: self._add_fixed_item(e, "expense"),
                    ),
                ],
                alignment=ft.MainAxisAlignment.SPACE_AROUND,
            )
        )
        
        return ft.Column(controls=items, spacing=8)
    
    def _create_record_list(self, records: list) -> List[ft.Container]:
        """创建交易记录列表"""
        if not records:
            return [ft.Text("暂无交易记录", size=14, color=ThemeConfig.TEXT_SECONDARY)]
        
        record_items = []
        for record in records:
            record_type, amount, category, description, created_at = record
            
            # 解析时间
            if isinstance(created_at, str):
                record_time = datetime.fromisoformat(created_at)
                time_str = record_time.strftime("%m-%d %H:%M")
            else:
                time_str = "未知时间"
            
            # 确定颜色和符号
            if record_type == "income":
                color = ThemeConfig.SUCCESS_COLOR
                sign = "+"
            else:
                color = ThemeConfig.DANGER_COLOR
                sign = "-"
            
            record_items.append(
                ft.Container(
                    content=ft.Row(
                        controls=[
                            ft.Column(
                                controls=[
                                    ft.Text(description or category or "未分类", size=14),
                                    ft.Text(time_str, size=12, color=ThemeConfig.TEXT_SECONDARY),
                                ],
                                spacing=2,
                            ),
                            ft.Text(
                                f"{sign}¥{amount:,.0f}",
                                size=16,
                                weight=ft.FontWeight.BOLD,
                                color=color,
                            ),
                        ],
                        alignment=ft.MainAxisAlignment.SPACE_BETWEEN,
                    ),
                    bgcolor=ThemeConfig.CARD_COLOR,
                    padding=10,
                    border_radius=8,
                )
            )
        
        return record_items
    
    def _show_add_record_dialog(self, e):
        """显示添加记录对话框"""
        page = e.page
        
        # 创建输入控件
        amount_field = ft.TextField(
            label="金额",
            prefix_text="¥",
            keyboard_type=ft.KeyboardType.NUMBER,
            width=300,
        )
        
        type_dropdown = ft.Dropdown(
            label="类型",
            width=300,
            options=[
                ft.dropdown.Option("income", "收入"),
                ft.dropdown.Option("expense", "支出"),
            ],
            value="expense",
        )
        
        category_dropdown = ft.Dropdown(
            label="分类",
            width=300,
            options=[
                ft.dropdown.Option("餐饮", "餐饮"),
                ft.dropdown.Option("交通", "交通"),
                ft.dropdown.Option("购物", "购物"),
                ft.dropdown.Option("娱乐", "娱乐"),
                ft.dropdown.Option("医疗", "医疗"),
                ft.dropdown.Option("教育", "教育"),
                ft.dropdown.Option("工资", "工资"),
                ft.dropdown.Option("投资", "投资"),
                ft.dropdown.Option("其他", "其他"),
            ],
            value="其他",
        )
        
        description_field = ft.TextField(
            label="备注（可选）",
            multiline=True,
            width=300,
            max_lines=3,
        )
        
        def close_dialog(e):
            dialog.open = False
            page.update()
        
        def save_record(e):
            if amount_field.value:
                try:
                    amount = float(amount_field.value)
                    self.db.add_finance_record(
                        record_type=type_dropdown.value,
                        amount=amount,
                        category=category_dropdown.value,
                        description=description_field.value or None,
                    )
                    close_dialog(e)
                    # 刷新页面
                    self._refresh_view(page)
                except ValueError:
                    # 显示错误提示
                    pass
        
        dialog = ft.AlertDialog(
            title=ft.Text("记一笔"),
            content=ft.Column(
                controls=[
                    type_dropdown,
                    amount_field,
                    category_dropdown,
                    description_field,
                ],
                height=250,
                spacing=10,
            ),
            actions=[
                ft.TextButton("取消", on_click=close_dialog),
                ft.TextButton("保存", on_click=save_record),
            ],
        )
        
        page.dialog = dialog
        dialog.open = True
        page.update()
    
    def _add_fixed_item(self, e, item_type: str):
        """添加固定收支项"""
        # TODO: 实现添加固定收支项的对话框
        pass
    
    def _edit_fixed_item(self, e, item_type: str, name: str, amount: float):
        """编辑固定收支项"""
        # TODO: 实现编辑固定收支项的对话框
        pass
    
    def _refresh_view(self, page):
        """刷新页面"""
        # 找到主窗口并刷新灵石页面
        for control in page.controls:
            if hasattr(control, 'controls') and len(control.controls) > 0:
                main_content = control.controls[0]
                if hasattr(main_content, 'controls'):
                    main_content.controls = [self.create_lingshi_view()]
                    page.update()
                    break

# systems/panel#
import flet as ft
from database.db_manager import DatabaseManager
from database.models import Task
from ui.styles import Styles
from ui.task_widgets import TaskWidget
from config import ThemeConfig

class PanelSystem:
    """个人面板系统"""
    
    def __init__(self, db_manager: DatabaseManager):
        self.db = db_manager
    
    def create_panel_view(self) -> ft.Column:
        """创建面板视图"""
        user_data = self.db.get_user_data()
        tasks = self.db.get_tasks()
        
        # 统计数据
        total_tasks = len(tasks)
        completed_tasks = sum(1 for t in tasks if t.completed_today)
        
        # 获取心境等级
        spirit_level, spirit_color = Styles.get_spirit_level_info(user_data.current_spirit)
        
        return ft.Column(
            controls=[
                # 标题
                ft.Container(
                    content=ft.Text("个人面板", size=20, weight=ft.FontWeight.BOLD),
                    padding=20,
                ),
                
                # 生命倒计时卡片（改为血量显示）
                self._create_life_card(user_data.current_blood),
                
                # 状态卡片组
                ft.Container(
                    content=ft.Row(
                        controls=[
                            self._create_status_card(
                                f"心境: {user_data.current_spirit}", 
                                spirit_level,
                                spirit_color
                            ),
                            self._create_status_card(
                                "境界", 
                                "练气期",
                                ThemeConfig.PRIMARY_COLOR
                            ),
                        ],
                        alignment=ft.MainAxisAlignment.SPACE_AROUND,
                    ),
                    margin=ft.margin.symmetric(horizontal=20, vertical=10),
                ),
                
                ft.Container(
                    content=ft.Row(
                        controls=[
                            self._create_status_card(
                                "任务", 
                                f"{completed_tasks}/{total_tasks}",
                                ThemeConfig.SUCCESS_COLOR
                            ),
                            self._create_status_card(
                                "灵石", 
                                f"{user_data.current_money/10000:.1f}万",
                                "#f6d365"
                            ),
                        ],
                        alignment=ft.MainAxisAlignment.SPACE_AROUND,
                    ),
                    margin=ft.margin.symmetric(horizontal=20),
                ),
                
                # 今日修炼标题
                ft.Container(
                    content=ft.Text("今日修炼", size=18, weight=ft.FontWeight.BOLD),
                    padding=ft.padding.only(left=20, top=20, bottom=10),
                ),
                
                # 任务列表
                ft.Container(
                    content=ft.Column(
                        controls=[
                            TaskWidget.create_task_item(task, lambda t, v: None, False) 
                            for task in tasks[:5]
                        ],
                        spacing=5,
                    ),
                    padding=ft.padding.symmetric(horizontal=20),
                ),
            ],
            scroll=ft.ScrollMode.AUTO,
            expand=True,
        )
    
    def _create_life_card(self, blood: int) -> ft.Container:
        """创建生命卡片（显示血量）"""
        return ft.Container(
            content=ft.Column(
                controls=[
                    ft.Text("剩余血量", size=14, color="white"),  # 改为血量
                    ft.Text(
                        f"{blood:,}",
                        size=32,
                        weight=ft.FontWeight.BOLD,
                        color="white"
                    ),
                    ft.Text("点", size=14, color="white"),  # 单位改为"点"
                ],
                alignment=ft.MainAxisAlignment.CENTER,
                horizontal_alignment=ft.CrossAxisAlignment.CENTER,
            ),
            padding=30,
            border_radius=20,
            gradient=Styles.get_gradient(ThemeConfig.LIFE_GRADIENT),
            margin=ft.margin.symmetric(horizontal=20),
        )
    
    def _create_status_card(self, title: str, value: str, color: str) -> ft.Container:
        """创建状态卡片"""
        return ft.Container(
            content=ft.Column(
                controls=[
                    ft.Text(title, size=12, color=ThemeConfig.TEXT_SECONDARY),
                    ft.Text(
                        value, 
                        size=18, 
                        weight=ft.FontWeight.BOLD,
                        color=color
                    ),
                ],
                alignment=ft.MainAxisAlignment.CENTER,
                horizontal_alignment=ft.CrossAxisAlignment.CENTER,
            ),
            bgcolor=ThemeConfig.CARD_COLOR,
            padding=15,
            border_radius=10,
            width=150,
            shadow=Styles.get_card_shadow(),
        )


# systems/settings#
import flet as ft
from database.db_manager import DatabaseManager
from config import VERSION, ThemeConfig
import json
import os
from datetime import datetime

class SettingsSystem:
    """设置系统"""
    
    def __init__(self, db_manager: DatabaseManager):
        self.db = db_manager
        self.settings = self._load_settings()
    
    def _load_settings(self) -> dict:
        """加载设置"""
        # 从配置文件或数据库加载设置
        default_settings = {
            "ai_provider": "none",
            "api_key": "",
            "api_url": "",
            "auto_backup": True,
            "backup_path": "",
            "birth_year": 1998,
            "target_money": 5000000,
            "theme_mode": "light",
            "font_size": "normal",
        }
        
        # TODO: 从数据库或配置文件加载实际设置
        return default_settings
    
    def _save_settings(self):
        """保存设置"""
        # TODO: 保存到数据库或配置文件
        pass
    
    def create_settings_view(self) -> ft.Column:
        """创建设置视图"""
        return ft.Column(
            controls=[
                # 标题栏
                ft.Container(
                    content=ft.Text("设置", size=20, weight=ft.FontWeight.BOLD),
                    padding=20,
                ),
                
                # AI接口设置
                ft.Container(
                    content=ft.Column(
                        controls=[
                            ft.Text("【AI接口设置】", size=14, color=ThemeConfig.TEXT_SECONDARY),
                            self._create_ai_settings(),
                        ],
                        spacing=10,
                    ),
                    padding=ft.padding.symmetric(horizontal=20, vertical=10),
                ),
                
                # 系统设置
                ft.Container(
                    content=ft.Column(
                        controls=[
                            ft.Text("【系统设置】", size=14, color=ThemeConfig.TEXT_SECONDARY),
                            self._create_system_settings(),
                        ],
                        spacing=10,
                    ),
                    padding=ft.padding.symmetric(horizontal=20, vertical=10),
                ),
                
                # 数据管理
                ft.Container(
                    content=ft.Column(
                        controls=[
                            ft.Text("【数据管理】", size=14, color=ThemeConfig.TEXT_SECONDARY),
                            self._create_data_settings(),
                        ],
                        spacing=10,
                    ),
                    padding=ft.padding.symmetric(horizontal=20, vertical=10),
                ),
                
                # 关于
                ft.Container(
                    content=ft.Column(
                        controls=[
                            ft.Text("【关于】", size=14, color=ThemeConfig.TEXT_SECONDARY),
                            self._create_about_section(),
                        ],
                        spacing=10,
                    ),
                    padding=ft.padding.symmetric(horizontal=20, vertical=10),
                ),
            ],
            scroll=ft.ScrollMode.AUTO,
            expand=True,
        )
    
    def _create_ai_settings(self) -> ft.Column:
        """创建AI设置部分"""
        provider_dropdown = ft.Dropdown(
            label="AI提供商",
            width=300,
            options=[
                ft.dropdown.Option("none", "不使用AI"),
                ft.dropdown.Option("openai", "OpenAI (ChatGPT)"),
                ft.dropdown.Option("qianwen", "通义千问"),
                ft.dropdown.Option("wenxin", "文心一言"),
                ft.dropdown.Option("chatglm", "ChatGLM"),
                ft.dropdown.Option("custom", "自定义API"),
            ],
            value=self.settings.get("ai_provider", "none"),
            on_change=self._on_ai_provider_change,
        )
        
        api_key_field = ft.TextField(
            label="API密钥",
            width=300,
            password=True,
            can_reveal_password=True,
            value=self.settings.get("api_key", ""),
            disabled=self.settings.get("ai_provider") == "none",
        )
        
        api_url_field = ft.TextField(
            label="API地址（可选）",
            width=300,
            value=self.settings.get("api_url", ""),
            hint_text="留空使用默认地址",
            disabled=self.settings.get("ai_provider") == "none",
        )
        
        test_button = ft.ElevatedButton(
            "测试连接",
            icon=ft.icons.WIFI,
            disabled=self.settings.get("ai_provider") == "none",
            on_click=self._test_ai_connection,
        )
        
        return ft.Column(
            controls=[
                provider_dropdown,
                api_key_field,
                api_url_field,
                test_button,
            ],
            spacing=10,
        )
    
    def _create_system_settings(self) -> ft.Column:
        """创建系统设置部分"""
        auto_backup_switch = ft.Switch(
            label="自动备份",
            value=self.settings.get("auto_backup", True),
            on_change=self._on_auto_backup_change,
        )
        
        birth_year_field = ft.TextField(
            label="出生年份",
            width=150,
            value=str(self.settings.get("birth_year", 1998)),
            keyboard_type=ft.KeyboardType.NUMBER,
            on_change=self._on_birth_year_change,
        )
        
        target_money_field = ft.TextField(
            label="目标灵石（万）",
            width=150,
            value=str(self.settings.get("target_money", 5000000) // 10000),
            keyboard_type=ft.KeyboardType.NUMBER,
            suffix_text="万",
            on_change=self._on_target_money_change,
        )
        
        theme_dropdown = ft.Dropdown(
            label="界面主题",
            width=150,
            options=[
                ft.dropdown.Option("light", "浅色"),
                ft.dropdown.Option("dark", "深色"),
                ft.dropdown.Option("system", "跟随系统"),
            ],
            value=self.settings.get("theme_mode", "light"),
            on_change=self._on_theme_change,
        )
        
        font_size_dropdown = ft.Dropdown(
            label="字体大小",
            width=150,
            options=[
                ft.dropdown.Option("small", "小"),
                ft.dropdown.Option("normal", "标准"),
                ft.dropdown.Option("large", "大"),
            ],
            value=self.settings.get("font_size", "normal"),
            on_change=self._on_font_size_change,
        )
        
        return ft.Column(
            controls=[
                auto_backup_switch,
                ft.Row([birth_year_field, target_money_field]),
                ft.Row([theme_dropdown, font_size_dropdown]),
            ],
            spacing=10,
        )
    
    def _create_data_settings(self) -> ft.Column:
        """创建数据管理部分"""
        export_button = ft.ElevatedButton(
            "导出数据",
            icon=ft.icons.DOWNLOAD,
            on_click=self._export_data,
        )
        
        import_button = ft.ElevatedButton(
            "导入数据",
            icon=ft.icons.UPLOAD,
            on_click=self._import_data,
        )
        
        backup_button = ft.ElevatedButton(
            "立即备份",
            icon=ft.icons.BACKUP,
            on_click=self._backup_now,
        )
        
        restore_button = ft.ElevatedButton(
            "恢复备份",
            icon=ft.icons.RESTORE,
            on_click=self._restore_backup,
        )
        
        clear_button = ft.ElevatedButton(
            "清除数据",
            icon=ft.icons.DELETE_FOREVER,
            bgcolor=ThemeConfig.DANGER_COLOR,
            color="white",
            on_click=self._clear_data_dialog,
        )
        
        return ft.Column(
            controls=[
                ft.Row([export_button, import_button]),
                ft.Row([backup_button, restore_button]),
                ft.Container(height=10),
                clear_button,
            ],
            spacing=10,
        )
    
    def _create_about_section(self) -> ft.Column:
        """创建关于部分"""
        return ft.Column(
            controls=[
                ft.Container(
                    content=ft.Column(
                        controls=[
                            ft.Text(f"凡人修仙3w天", size=16, weight=ft.FontWeight.BOLD),
                            ft.Text(f"版本: {VERSION}", size=14),
                            ft.Text("个人生命管理工具", size=12, color=ThemeConfig.TEXT_SECONDARY),
                            ft.Divider(height=20),
                            ft.Text("开发阶段:", size=12, weight=ft.FontWeight.BOLD),
                            ft.Text("✓ 第一阶段: MVP版本", size=12, color=ThemeConfig.SUCCESS_COLOR),
                            ft.Text("✓ 第二阶段: 功能完善", size=12, color=ThemeConfig.SUCCESS_COLOR),
                            ft.Text("○ 第三阶段: 优化提升", size=12, color=ThemeConfig.TEXT_SECONDARY),
                            ft.Divider(height=20),
                            ft.Row([
                                ft.TextButton(
                                    "使用指南",
                                    icon=ft.icons.HELP,
                                    on_click=self._show_guide,
                                ),
                                ft.TextButton(
                                    "检查更新",
                                    icon=ft.icons.UPDATE,
                                    on_click=self._check_update,
                                ),
                            ]),
                        ],
                        spacing=5,
                    ),
                    bgcolor=ThemeConfig.CARD_COLOR,
                    padding=15,
                    border_radius=10,
                ),
            ],
        )
    
    # 事件处理方法
    def _on_ai_provider_change(self, e):
        """AI提供商改变"""
        self.settings["ai_provider"] = e.control.value
        self._save_settings()
        # 更新相关控件状态
        e.page.update()
    
    def _on_auto_backup_change(self, e):
        """自动备份开关改变"""
        self.settings["auto_backup"] = e.control.value
        self._save_settings()
    
    def _on_birth_year_change(self, e):
        """出生年份改变"""
        try:
            year = int(e.control.value)
            if 1900 <= year <= datetime.now().year:
                self.settings["birth_year"] = year
                self._save_settings()
                # 更新数据库中的血量
                self._update_initial_blood(year)
        except ValueError:
            pass
    
    def _on_target_money_change(self, e):
        """目标灵石改变"""
        try:
            target = int(e.control.value) * 10000
            if target > 0:
                self.settings["target_money"] = target
                self._save_settings()
                # TODO: 更新数据库
        except ValueError:
            pass
    
    def _on_theme_change(self, e):
        """主题改变"""
        self.settings["theme_mode"] = e.control.value
        self._save_settings()
        # 应用主题
        if e.control.value == "dark":
            e.page.theme_mode = ft.ThemeMode.DARK
        elif e.control.value == "light":
            e.page.theme_mode = ft.ThemeMode.LIGHT
        else:
            e.page.theme_mode = ft.ThemeMode.SYSTEM
        e.page.update()
    
    def _on_font_size_change(self, e):
        """字体大小改变"""
        self.settings["font_size"] = e.control.value
        self._save_settings()
        # TODO: 应用字体大小
    
    def _test_ai_connection(self, e):
        """测试AI连接"""
        # TODO: 实现AI连接测试
        self._show_message(e.page, "功能开发中", "AI接口测试功能即将推出")
    
    def _export_data(self, e):
        """导出数据"""
        # TODO: 实现数据导出
        self._show_message(e.page, "导出成功", "数据已导出到下载目录")
    
    def _import_data(self, e):
        """导入数据"""
        # TODO: 实现数据导入
        self._show_message(e.page, "功能开发中", "数据导入功能即将推出")
    
    def _backup_now(self, e):
        """立即备份"""
        try:
            # TODO: 实现备份功能
            backup_time = datetime.now().strftime("%Y%m%d_%H%M%S")
            self._show_message(e.page, "备份成功", f"备份文件: backup_{backup_time}.db")
        except Exception as ex:
            self._show_message(e.page, "备份失败", str(ex))
    
    def _restore_backup(self, e):
        """恢复备份"""
        # TODO: 实现恢复功能
        self._show_message(e.page, "功能开发中", "备份恢复功能即将推出")
    
    def _clear_data_dialog(self, e):
        """显示清除数据确认对话框"""
        def confirm_clear(e):
            # TODO: 实现数据清除
            dialog.open = False
            e.page.update()
            self._show_message(e.page, "数据已清除", "所有数据已被删除")
        
        def cancel(e):
            dialog.open = False
            e.page.update()
        
        dialog = ft.AlertDialog(
            title=ft.Text("危险操作", color=ThemeConfig.DANGER_COLOR),
            content=ft.Text("确定要清除所有数据吗？此操作不可恢复！"),
            actions=[
                ft.TextButton("取消", on_click=cancel),
                ft.TextButton(
                    "确定清除",
                    on_click=confirm_clear,
                    style=ft.ButtonStyle(color=ThemeConfig.DANGER_COLOR)
                ),
            ],
        )
        
        e.page.dialog = dialog
        dialog.open = True
        e.page.update()
    
    def _show_guide(self, e):
        """显示使用指南"""
        guide_text = """
【基础概念】
• 血量：代表剩余生命时间，每分钟-1
• 心境：精力状态，范围-80到+200
• 境界：技能掌握程度
• 灵石：财务状况，1灵石=1元

【使用方法】
1. 在心境系统记录日常任务
2. 在境界系统追踪技能进度
3. 在灵石系统管理财务
4. 在统御系统维护人际关系

【修炼建议】
• 保持心境平衡，避免负面情绪
• 持续学习提升境界
• 合理理财积累灵石
• 定期维护重要关系
        """
        
        self._show_message(e.page, "使用指南", guide_text)
    
    def _check_update(self, e):
        """检查更新"""
        self._show_message(e.page, "已是最新版本", f"当前版本 {VERSION} 已是最新")
    
    def _update_initial_blood(self, birth_year: int):
        """更新初始血量"""
        age = datetime.now().year - birth_year
        initial_blood = (80 - age) * 365 * 24 * 60
        # TODO: 更新数据库中的血量设置
    
    def _show_message(self, page, title: str, content: str):
        """显示消息对话框"""
        def close_dialog(e):
            dialog.open = False
            page.update()
        
        dialog = ft.AlertDialog(
            title=ft.Text(title),
            content=ft.Text(content),
            actions=[
                ft.TextButton("确定", on_click=close_dialog),
            ],
        )
        
        page.dialog = dialog
        dialog.open = True
        page.update()

# systems/tongyu # 
import flet as ft
from database.db_manager import DatabaseManager
from config import ThemeConfig
from datetime import datetime
from typing import List, Dict

class TongyuSystem:
    """统御系统 - 人际关系管理"""
    
    def __init__(self, db_manager: DatabaseManager):
        self.db = db_manager
        
        # 示例数据，实际应从数据库加载
        self.family_members = [
            {
                "name": "父亲",
                "birthday": "1970-03-15",
                "phone": "138****1234",
                "notes": "喜欢钓鱼，注意血压",
                "events": [
                    {"date": "2024-03-15", "event": "生日", "completed": True},
                    {"date": "2024-06-16", "event": "父亲节", "completed": False},
                ]
            },
            {
                "name": "母亲",
                "birthday": "1972-08-20",
                "phone": "139****5678",
                "notes": "喜欢跳舞，胃不好",
                "events": [
                    {"date": "2024-05-12", "event": "母亲节", "completed": False},
                    {"date": "2024-08-20", "event": "生日", "completed": False},
                ]
            },
        ]
        
        self.friends = [
            {
                "name": "张三",
                "category": "挚友",
                "personality": "外向开朗",
                "hobbies": "篮球、游戏",
                "notes": "大学室友，在深圳工作",
                "last_contact": "2024-12-01",
                "events": [
                    {"date": "2024-12-31", "event": "跨年聚会", "completed": False},
                ]
            },
            {
                "name": "李四",
                "category": "同事",
                "personality": "稳重内敛",
                "hobbies": "读书、电影",
                "notes": "技术大牛，可以多交流",
                "last_contact": "2024-12-15",
                "events": []
            },
        ]
    
    def create_tongyu_view(self) -> ft.Column:
        """创建统御视图"""
        return ft.Column(
            controls=[
                # 标题栏
                ft.Container(
                    content=ft.Text("统御系统", size=20, weight=ft.FontWeight.BOLD),
                    padding=20,
                ),
                
                # 标签页
                ft.Container(
                    content=ft.Tabs(
                        selected_index=0,
                        animation_duration=300,
                        tabs=[
                            ft.Tab(
                                text="家族",
                                icon=ft.icons.HOME,
                                content=self._create_family_view(),
                            ),
                            ft.Tab(
                                text="朋友",
                                icon=ft.icons.PEOPLE,
                                content=self._create_friends_view(),
                            ),
                            ft.Tab(
                                text="关系网",
                                icon=ft.icons.ACCOUNT_TREE,
                                content=self._create_network_view(),
                            ),
                        ],
                    ),
                    padding=ft.padding.symmetric(horizontal=20),
                    expand=True,
                ),
            ],
            expand=True,
        )
    
    def _create_family_view(self) -> ft.Column:
        """创建家族视图"""
        family_cards = []
        
        for member in self.family_members:
            family_cards.append(self._create_family_card(member))
        
        return ft.Column(
            controls=[
                ft.Container(
                    content=ft.Row(
                        controls=[
                            ft.Text("家族成员", size=16, weight=ft.FontWeight.BOLD),
                            ft.IconButton(
                                icon=ft.icons.ADD,
                                bgcolor=ThemeConfig.PRIMARY_COLOR,
                                icon_color="white",
                                on_click=self._add_family_member,
                            ),
                        ],
                        alignment=ft.MainAxisAlignment.SPACE_BETWEEN,
                    ),
                    padding=ft.padding.only(bottom=10),
                ),
                *family_cards,
                
                # 家族事件提醒
                ft.Container(
                    content=ft.Column(
                        controls=[
                            ft.Text("【即将到来的事件】", size=14, weight=ft.FontWeight.BOLD),
                            ft.Divider(height=1),
                            *self._get_upcoming_family_events(),
                        ],
                        spacing=8,
                    ),
                    bgcolor=ThemeConfig.CARD_COLOR,
                    padding=15,
                    border_radius=10,
                    margin=ft.margin.only(top=20),
                ),
            ],
            scroll=ft.ScrollMode.AUTO,
            spacing=15,
        )
    
    def _create_family_card(self, member: dict) -> ft.Container:
        """创建家族成员卡片"""
        # 计算年龄
        birth_year = int(member["birthday"].split("-")[0])
        age = datetime.now().year - birth_year
        
        return ft.Container(
            content=ft.Column(
                controls=[
                    ft.Row(
                        controls=[
                            ft.Column(
                                controls=[
                                    ft.Text(member["name"], size=16, weight=ft.FontWeight.BOLD),
                                    ft.Text(f"{age}岁 | {member['phone']}", size=12, color=ThemeConfig.TEXT_SECONDARY),
                                ],
                                spacing=5,
                            ),
                            ft.IconButton(
                                icon=ft.icons.EDIT,
                                icon_size=18,
                                on_click=lambda e, m=member: self._edit_family_member(e, m),
                            ),
                        ],
                        alignment=ft.MainAxisAlignment.SPACE_BETWEEN,
                    ),
                    
                    ft.Container(
                        content=ft.Text(member["notes"], size=13, color=ThemeConfig.TEXT_SECONDARY),
                        padding=ft.padding.only(top=5),
                    ),
                    
                    # 事件列表
                    ft.Container(
                        content=ft.Column(
                            controls=[
                                ft.Row(
                                    controls=[
                                        ft.Checkbox(
                                            value=event["completed"],
                                            scale=0.8,
                                            on_change=lambda e, ev=event: self._toggle_family_event(e, member, ev),
                                        ),
                                        ft.Text(event["date"], size=12, color=ThemeConfig.TEXT_SECONDARY),
                                        ft.Text(event["event"], size=13),
                                    ],
                                )
                                for event in member["events"][:3]  # 只显示前3个事件
                            ],
                            spacing=5,
                        ),
                        padding=ft.padding.only(top=5),
                    ) if member["events"] else ft.Container(),
                ],
                spacing=8,
            ),
            bgcolor=ThemeConfig.CARD_COLOR,
            padding=15,
            border_radius=10,
        )
    
    def _create_friends_view(self) -> ft.Column:
        """创建朋友视图"""
        # 按类别分组
        friend_groups = {}
        for friend in self.friends:
            category = friend["category"]
            if category not in friend_groups:
                friend_groups[category] = []
            friend_groups[category].append(friend)
        
        friend_sections = []
        for category, friends in friend_groups.items():
            friend_sections.append(
                ft.Container(
                    content=ft.Column(
                        controls=[
                            ft.Text(f"【{category}】", size=14, weight=ft.FontWeight.BOLD),
                            *[self._create_friend_card(friend) for friend in friends],
                        ],
                        spacing=10,
                    ),
                    margin=ft.margin.only(bottom=15),
                )
            )
        
        return ft.Column(
            controls=[
                ft.Container(
                    content=ft.Row(
                        controls=[
                            ft.Text("朋友档案", size=16, weight=ft.FontWeight.BOLD),
                            ft.IconButton(
                                icon=ft.icons.PERSON_ADD,
                                bgcolor=ThemeConfig.PRIMARY_COLOR,
                                icon_color="white",
                                on_click=self._add_friend,
                            ),
                        ],
                        alignment=ft.MainAxisAlignment.SPACE_BETWEEN,
                    ),
                    padding=ft.padding.only(bottom=10),
                ),
                *friend_sections,
            ],
            scroll=ft.ScrollMode.AUTO,
            spacing=10,
        )
    
    def _create_friend_card(self, friend: dict) -> ft.Container:
        """创建朋友卡片"""
        # 计算多久没联系
        if friend.get("last_contact"):
            last_contact = datetime.strptime(friend["last_contact"], "%Y-%m-%d")
            days_ago = (datetime.now() - last_contact).days
            contact_text = f"上次联系: {days_ago}天前"
            contact_color = ThemeConfig.DANGER_COLOR if days_ago > 30 else ThemeConfig.TEXT_SECONDARY
        else:
            contact_text = "从未联系"
            contact_color = ThemeConfig.DANGER_COLOR
        
        return ft.Container(
            content=ft.ExpansionTile(
                title=ft.Text(friend["name"], size=14, weight=ft.FontWeight.BOLD),
                subtitle=ft.Text(contact_text, size=12, color=contact_color),
                initially_expanded=False,
                controls=[
                    ft.Container(
                        content=ft.Column(
                            controls=[
                                ft.Row([
                                    ft.Text("性格:", size=12, color=ThemeConfig.TEXT_SECONDARY),
                                    ft.Text(friend["personality"], size=12),
                                ]),
                                ft.Row([
                                    ft.Text("爱好:", size=12, color=ThemeConfig.TEXT_SECONDARY),
                                    ft.Text(friend["hobbies"], size=12),
                                ]),
                                ft.Row([
                                    ft.Text("备注:", size=12, color=ThemeConfig.TEXT_SECONDARY),
                                    ft.Text(friend["notes"], size=12),
                                ]),
                                ft.Row(
                                    controls=[
                                        ft.TextButton(
                                            "记录互动",
                                            icon=ft.icons.CHAT,
                                            on_click=lambda e, f=friend: self._record_interaction(e, f),
                                        ),
                                        ft.TextButton(
                                            "编辑",
                                            icon=ft.icons.EDIT,
                                            on_click=lambda e, f=friend: self._edit_friend(e, f),
                                        ),
                                    ],
                                ),
                            ],
                            spacing=8,
                        ),
                        padding=ft.padding.symmetric(horizontal=15),
                    ),
                ],
            ),
            bgcolor=ThemeConfig.CARD_COLOR,
            border_radius=10,
        )
    
    def _create_network_view(self) -> ft.Column:
        """创建关系网视图"""
        # 统计数据
        total_family = len(self.family_members)
        total_friends = len(self.friends)
        
        # 关系分类统计
        friend_categories = {}
        for friend in self.friends:
            category = friend["category"]
            friend_categories[category] = friend_categories.get(category, 0) + 1
        
        return ft.Column(
            controls=[
                # 统计卡片
                ft.Row(
                    controls=[
                        self._create_stat_card("家族成员", str(total_family), ft.icons.HOME),
                        self._create_stat_card("朋友总数", str(total_friends), ft.icons.PEOPLE),
                    ],
                    alignment=ft.MainAxisAlignment.SPACE_AROUND,
                ),
                
                # 朋友分类统计
                ft.Container(
                    content=ft.Column(
                        controls=[
                            ft.Text("【朋友分类】", size=14, weight=ft.FontWeight.BOLD),
                            ft.Divider(height=1),
                            *[
                                ft.Row(
                                    controls=[
                                        ft.Text(category, size=13),
                                        ft.Text(f"{count}人", size=13, color=ThemeConfig.PRIMARY_COLOR),
                                    ],
                                    alignment=ft.MainAxisAlignment.SPACE_BETWEEN,
                                )
                                for category, count in friend_categories.items()
                            ],
                        ],
                        spacing=10,
                    ),
                    bgcolor=ThemeConfig.CARD_COLOR,
                    padding=15,
                    border_radius=10,
                    margin=ft.margin.only(top=20),
                ),
                
                # 关系维护建议
                ft.Container(
                    content=ft.Column(
                        controls=[
                            ft.Text("【维护建议】", size=14, weight=ft.FontWeight.BOLD),
                            ft.Divider(height=1),
                            ft.Text("• 超过30天未联系的朋友有2人", size=13),
                            ft.Text("• 本月有3个家族事件需要关注", size=13),
                            ft.Text("• 建议每月至少与挚友联系一次", size=13),
                        ],
                        spacing=8,
                    ),
                    bgcolor="#FFF9E6",
                    padding=15,
                    border_radius=10,
                    margin=ft.margin.only(top=15),
                ),
            ],
            scroll=ft.ScrollMode.AUTO,
            spacing=15,
        )
    
    def _create_stat_card(self, title: str, value: str, icon) -> ft.Container:
        """创建统计卡片"""
        return ft.Container(
            content=ft.Column(
                controls=[
                    ft.Icon(icon, size=30, color=ThemeConfig.PRIMARY_COLOR),
                    ft.Text(value, size=24, weight=ft.FontWeight.BOLD),
                    ft.Text(title, size=12, color=ThemeConfig.TEXT_SECONDARY),
                ],
                alignment=ft.MainAxisAlignment.CENTER,
                horizontal_alignment=ft.CrossAxisAlignment.CENTER,
                spacing=5,
            ),
            bgcolor=ThemeConfig.CARD_COLOR,
            padding=20,
            border_radius=10,
            width=150,
        )
    
    def _get_upcoming_family_events(self) -> list:
        """获取即将到来的家族事件"""
        events = []
        for member in self.family_members:
            for event in member["events"]:
                if not event["completed"]:
                    events.append(
                        ft.Row(
                            controls=[
                                ft.Text(event["date"], size=12, color=ThemeConfig.TEXT_SECONDARY),
                                ft.Text(f"{member['name']}的{event['event']}", size=13),
                            ],
                        )
                    )
        return events[:5] if events else [ft.Text("暂无待办事件", size=13, color=ThemeConfig.TEXT_SECONDARY)]
    
    def _add_family_member(self, e):
        """添加家族成员"""
        # TODO: 实现添加家族成员对话框
        pass
    
    def _edit_family_member(self, e, member: dict):
        """编辑家族成员"""
        # TODO: 实现编辑家族成员对话框
        pass
    
    def _toggle_family_event(self, e, member: dict, event: dict):
        """切换家族事件完成状态"""
        event["completed"] = e.control.value
        # TODO: 保存到数据库
        e.page.update()
    
    def _add_friend(self, e):
        """添加朋友"""
        # TODO: 实现添加朋友对话框
        pass
    
    def _edit_friend(self, e, friend: dict):
        """编辑朋友信息"""
        # TODO: 实现编辑朋友对话框
        pass
    
    def _record_interaction(self, e, friend: dict):
        """记录互动"""
        friend["last_contact"] = datetime.now().strftime("%Y-%m-%d")
        # TODO: 保存到数据库，可以添加互动详情
        e.page.update()

# systems/xinjing #
import flet as ft
from typing import Callable
from database.db_manager import DatabaseManager
from ui.styles import Styles
from ui.task_widgets import TaskWidget
from config import ThemeConfig, GameConfig

class XinjingSystem():
    """心境系统"""
    
    def __init__(self, db_manager: DatabaseManager):
        self.db = db_manager
    
    def create_xinjing_view(self, on_task_toggle: Callable) -> ft.Column:
        """创建心境视图"""
        user_data = self.db.get_user_data()
        positive_tasks = self.db.get_tasks("positive")
        negative_tasks = self.db.get_tasks("negative")
        
        spirit_level, spirit_color = Styles.get_spirit_level_info(user_data.current_spirit)
        
        return ft.Column(
            controls=[
                # 标题
                ft.Container(
                    content=ft.Text("心境系统", size=20, weight=ft.FontWeight.BOLD),
                    padding=20,
                ),
                
                # 心境值显示
                ft.Container(
                    content=ft.Column(
                        controls=[
                            ft.Text(f"当前心境值: {user_data.current_spirit}", size=18),
                            ft.Text(spirit_level, size=16, color=spirit_color),
                        ],
                        horizontal_alignment=ft.CrossAxisAlignment.CENTER,
                    ),
                    padding=20,
                    alignment=ft.alignment.center,
                ),
                
                # 心境状态条
                ft.Container(
                    content=self._create_spirit_bar(user_data.current_spirit),
                    padding=ft.padding.symmetric(horizontal=20),
                ),
                
                # 正面修炼
                ft.Container(
                    content=ft.Text("【正面修炼】", size=16, weight=ft.FontWeight.BOLD),
                    padding=ft.padding.only(left=20, top=20, bottom=10),
                ),
                ft.Container(
                    content=ft.Column(
                        controls=[
                            TaskWidget.create_task_item(task, on_task_toggle)
                            for task in positive_tasks
                        ],
                        spacing=10,
                    ),
                    padding=ft.padding.symmetric(horizontal=20),
                ),
                
                # 心魔记录
                ft.Container(
                    content=ft.Text("【心魔记录】", size=16, weight=ft.FontWeight.BOLD),
                    padding=ft.padding.only(left=20, top=20, bottom=10),
                ),
                ft.Container(
                    content=ft.Column(
                        controls=[
                            TaskWidget.create_task_item(task, on_task_toggle)
                            for task in negative_tasks
                        ],
                        spacing=10,
                    ),
                    padding=ft.padding.symmetric(horizontal=20),
                ),
            ],
            scroll=ft.ScrollMode.AUTO,
            expand=True,
        )
    
    def _create_spirit_bar(self, value: int) -> ft.Container:
        """创建心境状态条"""
        min_val = -80
        max_val = 200
        percentage = (value - min_val) / (max_val - min_val)
        percentage = max(0, min(1, percentage))
        
        return ft.Container(
            content=ft.Stack(
                controls=[
                    ft.Container(
                        height=8,
                        border_radius=4,
                        gradient=ft.LinearGradient(
                            begin=ft.alignment.center_left,
                            end=ft.alignment.center_right,
                            colors=["#ff0000", "#ffa500", "#90ee90", "#4169e1", "#9370db"],
                        ),
                    ),
                    ft.Container(
                        width=20,
                        height=20,
                        border_radius=10,
                        bgcolor="white",
                        border=ft.border.all(3, "#667eea"),
                        left=percentage * 280,
                        top=-6,
                    ),
                ],
            ),
            width=300,
            height=20,
        )

# database/db_manager#
import sqlite3
import json
from datetime import datetime, date
from typing import List, Optional
from pathlib import Path
import os

from database.models import Task, UserData, TaskRecord
from config import DB_PATH, GameConfig

class DatabaseManager:
    """数据库管理器"""
    
    def __init__(self, db_path: str = None):
        # 使用绝对路径，确保有写权限的目录
        if db_path is None:
            # 使用用户主目录或应用数据目录
            if os.name == 'nt':  # Windows
                app_data = os.path.expanduser('~\\AppData\\Local\\FanRenXiuXian')
            else:  # Linux/Mac
                app_data = os.path.expanduser('~/.fanrenxiuxian')
            
            # 创建目录如果不存在
            os.makedirs(app_data, exist_ok=True)
            self.db_path = os.path.join(app_data, 'immortal_cultivation.db')
        else:
            self.db_path = db_path
            
        print(f"数据库路径: {self.db_path}")
        
        # 检查并设置文件权限
        self._check_permissions()
        self.init_database()
    
    def _check_permissions(self):
        """检查并设置数据库文件权限"""
        if os.path.exists(self.db_path):
            try:
                # 尝试设置文件为可写
                os.chmod(self.db_path, 0o666)
            except:
                pass
    
    def _get_connection(self):
        """获取数据库连接，统一处理连接参数"""
        conn = sqlite3.connect(
            self.db_path,
            timeout=10.0,  # 增加超时时间
            check_same_thread=False  # 允许多线程访问
        )
        # 设置WAL模式，提高并发性能
        conn.execute('PRAGMA journal_mode=WAL')
        conn.execute('PRAGMA synchronous=NORMAL')
        return conn
    
    def init_database(self):
        """初始化数据库表结构"""
        try:
            conn = self._get_connection()
            cursor = conn.cursor()
            
            # 用户配置表
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS user_config (
                    id INTEGER PRIMARY KEY,
                    birth_year INTEGER NOT NULL,
                    initial_blood INTEGER NOT NULL,
                    current_blood INTEGER NOT NULL,
                    current_spirit INTEGER DEFAULT 0,
                    current_money INTEGER DEFAULT 0,
                    target_money INTEGER DEFAULT 5000000,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            # 任务表
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS tasks (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    category TEXT NOT NULL,
                    spirit_effect INTEGER DEFAULT 0,
                    blood_effect INTEGER DEFAULT 0,
                    frequency TEXT DEFAULT 'daily',
                    status INTEGER DEFAULT 1,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            # 任务记录表
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS task_records (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    task_id INTEGER NOT NULL,
                    completed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    spirit_change INTEGER,
                    blood_change INTEGER,
                    FOREIGN KEY (task_id) REFERENCES tasks(id)
                )
            ''')
            
            # 财务记录表
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS finance_records (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    type TEXT NOT NULL,
                    amount DECIMAL NOT NULL,
                    category TEXT,
                    description TEXT,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            # 技能进度表
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS skill_progress (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    skill_name TEXT NOT NULL,
                    parent_id INTEGER,
                    total_nodes INTEGER DEFAULT 0,
                    completed_nodes INTEGER DEFAULT 0,
                    realm_level TEXT,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            conn.commit()
            conn.close()
            
            # 初始化默认数据
            self._init_default_data()
            
        except Exception as e:
            print(f"数据库初始化错误: {e}")
            if conn:
                conn.close()
    
    def _init_default_data(self):
        """初始化默认数据"""
        try:
            conn = self._get_connection()
            cursor = conn.cursor()
            
            # 初始化用户数据
            cursor.execute("SELECT COUNT(*) FROM user_config")
            if cursor.fetchone()[0] == 0:
                birth_year = 1998
                age = datetime.now().year - birth_year
                initial_blood = (80 - age) * 365 * 24 * 60
                
                cursor.execute('''
                    INSERT INTO user_config 
                    (birth_year, initial_blood, current_blood, current_spirit, current_money, target_money)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', (birth_year, initial_blood, initial_blood, 0, 125840, 5000000))
            
            # 初始化默认任务
            cursor.execute("SELECT COUNT(*) FROM tasks")
            if cursor.fetchone()[0] == 0:
                default_tasks = [
                    ("早起", "positive", 1, 0, "daily"),
                    ("晨跑30分钟", "positive", 1, 1, "daily"),
                    ("八部金刚功", "positive", 1, 2, "daily"),
                    ("冥想15分钟", "positive", 2, 0, "daily"),
                    ("阅读1小时", "positive", 1, 0, "daily"),
                    ("控制情绪", "positive", 1, 0, "daily"),
                    ("打扫房间", "positive", 1, 0, "daily"),
                    ("熬夜", "negative", -3, -1, "daily"),
                    ("刷自媒体", "negative", -3, 0, "daily"),
                    ("打游戏", "negative", -3, 0, "daily"),
                    ("发脾气", "negative", -3, -3, "daily"),
                    ("晚起", "negative", -2, 0, "daily"),
                ]
                
                for task in default_tasks:
                    cursor.execute('''
                        INSERT INTO tasks (name, category, spirit_effect, blood_effect, frequency)
                        VALUES (?, ?, ?, ?, ?)
                    ''', task)
            
            conn.commit()
            conn.close()
            
        except Exception as e:
            print(f"初始化默认数据错误: {e}")
            if conn:
                conn.close()
    
    def get_user_data(self) -> Optional[UserData]:
        """获取用户数据"""
        try:
            conn = self._get_connection()
            cursor = conn.cursor()
            
            cursor.execute('''
                SELECT birth_year, current_spirit, current_blood, target_money, current_money 
                FROM user_config LIMIT 1
            ''')
            row = cursor.fetchone()
            conn.close()
            
            if row:
                return UserData(
                    birth_year=row[0],
                    current_spirit=row[1] or 0,
                    current_blood=row[2],
                    target_money=row[3],
                    current_money=row[4] or 0
                )
            return None
        except Exception as e:
            print(f"获取用户数据错误: {e}")
            return None
    
    def update_spirit_blood(self, spirit_change: int = 0, blood_change: int = 0):
        """更新心境和血量"""
        conn = None
        try:
            conn = self._get_connection()
            cursor = conn.cursor()
            
            # 先检查当前血量
            cursor.execute('SELECT current_blood, current_spirit FROM user_config WHERE id = 1')
            result = cursor.fetchone()
            
            if result:
                current_blood, current_spirit = result
                # 确保血量不会变为负数
                new_blood = max(0, current_blood + blood_change)
                # 确保心境在范围内
                new_spirit = max(GameConfig.MIN_SPIRIT, 
                               min(GameConfig.MAX_SPIRIT, current_spirit + spirit_change))
                
                cursor.execute('''
                    UPDATE user_config 
                    SET current_spirit = ?,
                        current_blood = ?
                    WHERE id = 1
                ''', (new_spirit, new_blood))
                
                conn.commit()
                return True
            
            return False
            
        except Exception as e:
            print(f"更新心境血量错误: {e}")
            if conn:
                conn.rollback()
            return False
        finally:
            if conn:
                conn.close()
    
    def decrease_blood_by_time(self, amount: int = 1):
        """按时间减少血量（用于定时器）"""
        return self.update_spirit_blood(0, -amount)
    
    def get_tasks(self, category: Optional[str] = None) -> List[Task]:
        """获取任务列表"""
        try:
            conn = self._get_connection()
            cursor = conn.cursor()
            
            if category:
                cursor.execute('''
                    SELECT id, name, category, spirit_effect, blood_effect, frequency 
                    FROM tasks WHERE status = 1 AND category = ?
                    ORDER BY id
                ''', (category,))
            else:
                cursor.execute('''
                    SELECT id, name, category, spirit_effect, blood_effect, frequency 
                    FROM tasks WHERE status = 1
                    ORDER BY category DESC, id
                ''')
            
            rows = cursor.fetchall()
            
            # 检查今日完成情况
            today = date.today().isoformat()
            cursor.execute('''
                SELECT task_id FROM task_records 
                WHERE DATE(completed_at) = ?
            ''', (today,))
            completed_ids = {row[0] for row in cursor.fetchall()}
            
            conn.close()
            
            tasks = []
            for row in rows:
                tasks.append(Task(
                    id=row[0],
                    name=row[1],
                    category=row[2],
                    spirit_effect=row[3],
                    blood_effect=row[4],
                    frequency=row[5],
                    completed_today=(row[0] in completed_ids)
                ))
            
            return tasks
            
        except Exception as e:
            print(f"获取任务列表错误: {e}")
            return []
    
    def complete_task(self, task_id: int, spirit_effect: int, blood_effect: int):
        """完成任务"""
        conn = None
        try:
            conn = self._get_connection()
            cursor = conn.cursor()
            
            # 检查今天是否已经完成过
            today = date.today().isoformat()
            cursor.execute('''
                SELECT COUNT(*) FROM task_records 
                WHERE task_id = ? AND DATE(completed_at) = ?
            ''', (task_id, today))
            
            if cursor.fetchone()[0] == 0:
                cursor.execute('''
                    INSERT INTO task_records (task_id, spirit_change, blood_change)
                    VALUES (?, ?, ?)
                ''', (task_id, spirit_effect, blood_effect))
                
                conn.commit()
                self.update_spirit_blood(spirit_effect, blood_effect)
            
        except Exception as e:
            print(f"完成任务错误: {e}")
            if conn:
                conn.rollback()
        finally:
            if conn:
                conn.close()
    
    def uncomplete_task(self, task_id: int, spirit_effect: int, blood_effect: int):
        """取消完成任务"""
        conn = None
        try:
            conn = self._get_connection()
            cursor = conn.cursor()
            
            today = date.today().isoformat()
            cursor.execute('''
                DELETE FROM task_records 
                WHERE task_id = ? AND DATE(completed_at) = ?
            ''', (task_id, today))
            
            if cursor.rowcount > 0:
                conn.commit()
                self.update_spirit_blood(-spirit_effect, -blood_effect)
            
        except Exception as e:
            print(f"取消任务错误: {e}")
            if conn:
                conn.rollback()
        finally:
            if conn:
                conn.close()
    
    def add_task(self, name: str, category: str, spirit_effect: int, blood_effect: int):
        """添加新任务"""
        conn = None
        try:
            conn = self._get_connection()
            cursor = conn.cursor()
            
            cursor.execute('''
                INSERT INTO tasks (name, category, spirit_effect, blood_effect)
                VALUES (?, ?, ?, ?)
            ''', (name, category, spirit_effect, blood_effect))
            
            conn.commit()
            
        except Exception as e:
            print(f"添加任务错误: {e}")
            if conn:
                conn.rollback()
        finally:
            if conn:
                conn.close()
    
    def add_finance_record(self, record_type: str, amount: float, category: str = None, description: str = None):
        """添加财务记录"""
        conn = None
        try:
            conn = self._get_connection()
            cursor = conn.cursor()
            
            cursor.execute('''
                INSERT INTO finance_records (type, amount, category, description)
                VALUES (?, ?, ?, ?)
            ''', (record_type, amount, category, description))
            
            # 更新当前灵石数量
            if record_type == "income":
                cursor.execute('''
                    UPDATE user_config 
                    SET current_money = current_money + ?
                    WHERE id = 1
                ''', (amount,))
            elif record_type == "expense":
                cursor.execute('''
                    UPDATE user_config 
                    SET current_money = current_money - ?
                    WHERE id = 1
                ''', (amount,))
            
            conn.commit()
            
        except Exception as e:
            print(f"添加财务记录错误: {e}")
            if conn:
                conn.rollback()
        finally:
            if conn:
                conn.close()
    
    def get_finance_records(self, limit: int = 20) -> list:
        """获取财务记录"""
        try:
            conn = self._get_connection()
            cursor = conn.cursor()
            
            cursor.execute('''
                SELECT type, amount, category, description, created_at
                FROM finance_records
                ORDER BY created_at DESC
                LIMIT ?
            ''', (limit,))
            
            records = cursor.fetchall()
            conn.close()
            
            return records
            
        except Exception as e:
            print(f"获取财务记录错误: {e}")
            return []

# database/models.py#
from dataclasses import dataclass
from datetime import datetime
from typing import Optional

@dataclass
class Task():
    """任务模型"""
    id: int
    name: str
    category: str  # positive/negative
    spirit_effect: int
    blood_effect: int
    frequency: str = "daily"
    completed_today: bool = False
    created_at: Optional[datetime] = None

@dataclass
class UserData:
    """用户数据模型"""
    birth_year: int
    current_spirit: int
    current_blood: int
    target_money: int
    current_money: int
    created_at: Optional[datetime] = None

@dataclass
class TaskRecord:
    """任务记录模型"""
    id: int
    task_id: int
    completed_at: datetime
    spirit_change: int
    blood_change: int
	
	
# assets/initial_tasks.json#
{
    "positive_tasks": [
        {"name": "早起", "spirit_effect": 1, "blood_effect": 0},
        {"name": "晨跑30分钟", "spirit_effect": 1, "blood_effect": 1},
        {"name": "八部金刚功", "spirit_effect": 1, "blood_effect": 2},
        {"name": "冥想15分钟", "spirit_effect": 2, "blood_effect": 0},
        {"name": "阅读1小时", "spirit_effect": 1, "blood_effect": 0},
        {"name": "控制情绪", "spirit_effect": 1, "blood_effect": 0},
        {"name": "打扫房间", "spirit_effect": 1, "blood_effect": 0}
    ],
    "negative_tasks": [
        {"name": "熬夜", "spirit_effect": -3, "blood_effect": -1},
        {"name": "刷自媒体", "spirit_effect": -3, "blood_effect": 0},
        {"name": "打游戏", "spirit_effect": -3, "blood_effect": 0},
        {"name": "发脾气", "spirit_effect": -3, "blood_effect": -3},
        {"name": "晚起", "spirit_effect": -2, "blood_effect": 0}
    ]
}


开发到了第二阶段 为什么我运行了main.py以后 点任何按钮都没有效果 排查这个原因 